<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendário Interativo - notIFy</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #loginScreen, #calendarApp, #inscriptionsApp { width:100vw; height:100vh; display:flex; justify-content:center; align-items:center; background:#f7f7f7; }
    #loginBox { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); width:300px; }
    #loginBox input,#loginBox button { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
    #loginBox button { background:#228b22; color:#fff; border:none; cursor:pointer; }
    #calendarContainer { position:relative; width:100%; height:100%; }
    #addEventBtn,#logoutBtn,#inscriptionsBtn,#userCardBtn { position:fixed; top:20px; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; color:#fff; z-index:1001; }
    #addEventBtn { left:20px; background:#228b22; }
    #inscriptionsBtn { left:150px; background:#007bff; }
    #userCardBtn { left:320px; background:#ff9800; }
    #addEventBtn,#logoutBtn,#inscriptionsBtn { position:fixed; top:20px; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; color:#fff; z-index:1001; }
    #addEventBtn { left:20px; background:#228b22; }
    #inscriptionsBtn { left:150px; background:#007bff; }
    #logoutBtn { right:20px; background:#d9534f; }
    #calendar { max-width:900px; margin:80px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; }
    .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:1001; width:300px; }
    .modal label { display:block; margin-bottom:5px; }
    .modal input, .modal textarea { width:100%; margin-bottom:10px; padding:8px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
    .modal button { padding:8px 12px; border:none; border-radius:5px; cursor:pointer; background:#228b22; color:#fff; margin-right:5px; }
    #inscriptionsList { max-width:600px; margin:80px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .inscription { margin-bottom:15px; }
    .inscription h4 { margin:0 0 5px 0; }
    .inscription p { margin:2px 0; }
    #backToCalendar { margin-top:20px; padding:8px 12px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="loginScreen">
    <div id="loginBox">
      <h3>Login</h3>
      <input type="text" id="username" placeholder="Usuário" />
      <input type="password" id="password" placeholder="Senha" />
      <button id="loginBtn">Entrar</button>
    </div>
  </div>
  <div id="calendarApp" style="display:none;">
    <div id="calendarContainer">
      <button id="addEventBtn">Adicionar Evento</button>
      <button id="inscriptionsBtn">Minhas Inscrições</button>
      <button id="userCardBtn">Cartão do Usuário</button>
      <button id="logoutBtn">Sair</button>
      <div id="calendar"></div>
    </div>
  </div>
  <div id="inscriptionsApp" style="display:none;">
    <div id="inscriptionsList"></div>
    <button id="backToCalendar">Voltar ao Calendário</button>
  </div>
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="addModal">
    <h3 id="modalTitle">Adicionar Evento</h3>
    <label for="eventTitle">Título:</label>
    <input type="text" id="eventTitle" />
    <label for="eventStart">Início:</label>
    <input type="datetime-local" id="eventStart" />
    <label for="eventEnd">Término:</label>
    <input type="datetime-local" id="eventEnd" />
    <label for="eventDescription">Descrição:</label>
    <textarea id="eventDescription" rows="3"></textarea>
    <label for="eventImage">Imagem:</label>
    <input type="file" id="eventImage" accept="image/*" />
    <button id="saveEvent">Salvar</button>
    <button id="cancelAdd">Cancelar</button>
  </div>
  <div class="modal" id="viewModal">
    <h3 id="viewTitle"></h3>
    <p id="viewDesc"></p>
    <img id="viewImg" src="" alt="" style="width:100%;display:none;margin-bottom:10px;" />
    <button id="inscribeBtn">Inscrever-se</button>
    <!-- Botão novo: exportar lista de participantes (aparece apenas para organizador) -->
    <button id="exportParticipantsBtn" style="display:none;">Exibir lista de participantes</button>
    <button id="readQrBtn" style="display:none;">Ler QR code</button>
    <button id="editEvent">Editar</button>
    <button id="deleteEvent">Excluir</button>
    <button id="closeView">Fechar</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <!-- PapaParse (biblioteca para gerar CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    let userRole='user';
    const loginScreen=document.getElementById('loginScreen');
    const calendarApp=document.getElementById('calendarApp');
    const inscriptionsApp=document.getElementById('inscriptionsApp');
    const addBtn=document.getElementById('addEventBtn');
    const inscBtn=document.getElementById('inscriptionsBtn');
    const userCardBtn=document.getElementById('userCardBtn');
    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const backBtn=document.getElementById('backToCalendar');
    const eventImageInput=document.getElementById('eventImage');
    let calendar, imageData=null;
    let eventsData=JSON.parse(localStorage.getItem('eventsData'))||[];
    let registrations=JSON.parse(localStorage.getItem('registrations'))||[];
    function persistEvents(){localStorage.setItem('eventsData',JSON.stringify(eventsData));}
    function persistRegs(){localStorage.setItem('registrations',JSON.stringify(registrations));}
    loginBtn.addEventListener('click',()=>{
      const uname=document.getElementById('username').value.trim().toLowerCase();
      userRole=(uname==='organizador'?'organizador':'user');
      inscBtn.style.display = (userRole==='user'?'inline-block':'none');
      userCardBtn.style.display = (userRole==='user'?'inline-block':'none');
      loginScreen.style.display='none';calendarApp.style.display='flex';
      addBtn.style.display=(userRole==='organizador'?'inline-block':'none');
      initCalendar();
    });
    userCardBtn.addEventListener('click',()=>{
      window.location.href='index5.html';
    });
    logoutBtn.addEventListener('click',()=>{eventsData=calendar.getEvents().map(e=>({title:e.title,start:e.start,end:e.end,extendedProps:e.extendedProps}));persistEvents();calendar.destroy();calendar=null;calendarApp.style.display='none';loginScreen.style.display='flex';});
    inscBtn.addEventListener('click',()=>{
      calendarApp.style.display='none';inscriptionsApp.style.display='flex';
      const list=document.getElementById('inscriptionsList');list.innerHTML='';
      registrations.forEach(ev=>{
        const div=document.createElement('div');div.className='inscription';
        const d=new Date(ev.start);
        div.innerHTML=`<h4>${ev.title}</h4><p>${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p>`;
        list.appendChild(div);
      });
    });
    backBtn.addEventListener('click',()=>{inscriptionsApp.style.display='none';calendarApp.style.display='flex';});
    eventImageInput.addEventListener('change',e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>imageData=ev.target.result;r.readAsDataURL(f);} });
    function initCalendar(){
      const overlay=document.getElementById('overlay');
      const addModal=document.getElementById('addModal');
      const viewModal=document.getElementById('viewModal');
      const saveEvent=document.getElementById('saveEvent');
      const cancelAdd=document.getElementById('cancelAdd');
      const closeView=document.getElementById('closeView');
      const editEvent=document.getElementById('editEvent');
      const deleteEvent=document.getElementById('deleteEvent');
      const inscribeBtn=document.getElementById('inscribeBtn');
      const exportBtn=document.getElementById('exportParticipantsBtn');
      const readQrBtn=document.getElementById('readQrBtn');
      let currentEvent=null;
      function showO(){overlay.style.display='block';}
      function hideO(){overlay.style.display='none';}
      function toggle(m,s){m.style.display=s?'block':'none';}
      function clear(){document.getElementById('eventTitle').value='';document.getElementById('eventStart').value='';document.getElementById('eventEnd').value='';document.getElementById('eventDescription').value='';eventImageInput.value='';imageData=null;}
      function color(s,e){const n=new Date();if(n<new Date(s))return'green';if(n<=new Date(e))return'yellow';return'red';}
      calendar=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',locale:'pt-br',headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay'},events:eventsData,eventClick:info=>{currentEvent=info.event;document.getElementById('viewTitle').innerText=info.event.title;document.getElementById('viewDesc').innerText=info.event.extendedProps.description||'';const imgEl=document.getElementById('viewImg');if(info.event.extendedProps.image){imgEl.src=info.event.extendedProps.image;imgEl.style.display='block';}else imgEl.style.display='none';const exists = registrations.some(r => r.title===info.event.title && r.start===info.event.start);inscribeBtn.innerText = exists ? 'Remover inscrição' : 'Inscrever-se';
        // mostrar/ocultar botões conforme papel do usuário
        editEvent.style.display=userRole==='organizador'?'inline-block':'none';
        deleteEvent.style.display=userRole==='organizador'?'inline-block':'none';
        inscribeBtn.style.display=userRole==='user'?'inline-block':'none';
        exportBtn.style.display = userRole==='organizador'?'inline-block':'none';
        // mostrar botão Ler QR somente se for organizador E se o evento estiver em andamento (amarelo)
        const evtColor = color(info.event.start, info.event.end);
        readQrBtn.style.display = (userRole==='organizador' && evtColor==='yellow') ? 'inline-block' : 'none';
        showO();toggle(viewModal,true);
      },eventDidMount:info=>{const c=color(info.event.start,info.event.end);info.el.style.backgroundColor=c;info.el.style.borderColor=c;}});
      calendar.render();
      addBtn.addEventListener('click',()=>{currentEvent=null;clear();document.getElementById('modalTitle').innerText='Adicionar Evento';showO();toggle(addModal,true);});
      saveEvent.addEventListener('click',()=>{const t=document.getElementById('eventTitle').value;const s=document.getElementById('eventStart').value;const e=document.getElementById('eventEnd').value;const d=document.getElementById('eventDescription').value;if(!t||!s||!e)return alert('Preencha todos os campos!');const img=imageData||(currentEvent?currentEvent.extendedProps.image:null);const ev={title:t,start:s,end:e,extendedProps:{description:d,image:img}};if(currentEvent){currentEvent.setProp('title',t);currentEvent.setStart(s);currentEvent.setEnd(e);currentEvent.setExtendedProp('description',d);currentEvent.setExtendedProp('image',img);}else{calendar.addEvent(ev);}eventsData=calendar.getEvents().map(e=>({title:e.title,start:e.start,end:e.end,extendedProps:e.extendedProps}));persistEvents();toggle(addModal,false);hideO();});
      cancelAdd.addEventListener('click',()=>{toggle(addModal,false);hideO();});closeView.addEventListener('click',()=>{toggle(viewModal,false);hideO();});
      editEvent.addEventListener('click',()=>{if(!currentEvent)return;document.getElementById('modalTitle').innerText='Editar Evento';document.getElementById('eventTitle').value=currentEvent.title;document.getElementById('eventStart').value=currentEvent.start.toISOString().slice(0,16);document.getElementById('eventEnd').value=currentEvent.end.toISOString().slice(0,16);document.getElementById('eventDescription').value=currentEvent.extendedProps.description||'';imageData=currentEvent.extendedProps.image||null;toggle(viewModal,false);showO();toggle(addModal,true);});
      deleteEvent.addEventListener('click',()=>{if(currentEvent){currentEvent.remove();eventsData=calendar.getEvents().map(e=>({title:e.title,start:e.start,end:e.end,extendedProps:e.extendedProps}));persistEvents();}toggle(viewModal,false);hideO();});
      inscribeBtn.addEventListener('click',()=>{if(!currentEvent) return;const idx=registrations.findIndex(r=>r.title===currentEvent.title&&r.start===currentEvent.start);if(idx===-1){registrations.push({title:currentEvent.title,start:currentEvent.start});alert('Inscrito com sucesso!');inscribeBtn.innerText='Remover inscrição';}else{registrations.splice(idx,1);alert('Inscrição removida com sucesso!');inscribeBtn.innerText='Inscrever-se';}persistRegs();toggle(viewModal,false);hideO();});

      // Listener adicional para abrir index2.html (Ler QR code)
      if (readQrBtn) {
        readQrBtn.addEventListener('click', () => {
          if (!currentEvent) return;
          window.location.href = 'index2.html';
        });
      }

      // Novo: exportar lista de participantes (protótipo, mesma lista fixa para todos os eventos)
      exportBtn.addEventListener('click',()=>{
        if(!currentEvent) return;
        // lista fixa de 5 participantes (protótipo)
        const participants = [
          { Nome: 'Ana Beatriz Silva', CPF: '123.456.789-00', RA: '2023001' },
          { Nome: 'Bruno Carlos Souza', CPF: '987.654.321-11', RA: '2023002' },
          { Nome: 'Carla Mariana Lima', CPF: '111.222.333-44', RA: '2023003' },
          { Nome: 'Diego Henrique Rocha', CPF: '555.666.777-88', RA: '2023004' },
          { Nome: 'Eduarda Fernanda Alves', CPF: '999.888.777-66', RA: '2023005' }
        ];
        const csv = Papa.unparse(participants);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // filename com o título do evento (sanitizado)
        const safeTitle = (currentEvent.title || 'event').replace(/[^a-z0-9\-_, ]/gi,'').replace(/\s+/g,'_');
        a.download = `${safeTitle}_participants.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

    }
  </script>
</body>
</html>
