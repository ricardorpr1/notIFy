<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notIFy — Calendário</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
  <style>
    body { margin:0; font-family:Arial, Helvetica, sans-serif; background:#f7f7f7; }
    #calendarContainer { max-width:900px; margin:60px auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    #addEventBtn { position:fixed; top:20px; left:20px; background:#228b22; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; z-index:1100; }
    #addEventBtn:hover { background:#1e7a1e; }

    /* overlay + modal */
    #overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1200; align-items:center; justify-content:center; }
    #modal { background:#fff; width:90%; max-width:760px; border-radius:10px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,0.25); max-height:90vh; overflow:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .modal-title { margin:0; font-size:20px; }
    .modal-close { background:transparent; border:none; font-size:24px; cursor:pointer; }
    .modal-body { display:grid; grid-template-columns:1fr 320px; gap:16px; margin-top:12px; }
    .modal-desc { white-space:pre-wrap; color:#333; }
    .modal-image { width:100%; height:100%; object-fit:cover; border-radius:6px; display:block; max-height:360px; }
    .modal-footer { margin-top:14px; display:flex; justify-content:flex-end; gap:8px; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
    .btn-close { background:#6c757d; color:#fff; }
    .btn-delete { background:#d9534f; color:#fff; }

    @media (max-width:780px) {
      .modal-body { grid-template-columns:1fr; }
      .modal-image { max-height:200px; }
    }
  </style>
</head>
<body>
  <button id="addEventBtn" onclick="location.href='adicionarevento.html'">Adicionar Evento</button>

  <div id="calendarContainer">
    <div id="calendar"></div>
  </div>

  <!-- Modal / Overlay -->
  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div id="modal">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Título</h3>
        <button class="modal-close" id="modalClose" aria-label="Fechar">&times;</button>
      </div>

      <div class="modal-body">
        <div>
          <p id="modalDescription" class="modal-desc">Descrição</p>
          <p style="color:#666; margin-top:10px;"><strong>Local:</strong> <span id="modalLocation">—</span></p>
        </div>
        <div>
          <img id="modalImage" class="modal-image" src="" alt="Capa do evento" style="display:none" />
        </div>
      </div>

      <div class="modal-footer">
        <button id="btnClose" class="btn btn-close">Fechar</button>
        <button id="btnDelete" class="btn btn-delete">Excluir evento</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script>
    // Escopo superior
    let calendar;
    let selectedEventId = null; // id atual do evento selecionado (string ou number)

    // Helper: monta ISO datetime "YYYY-MM-DDTHH:MM:SS" a partir de date + time (aceita HH:MM ou HH:MM:SS)
    function makeIsoDatetime(dateStr, timeStr) {
      if (!dateStr) return null;
      if (!timeStr || timeStr === '00:00' || timeStr === '00:00:00') return dateStr; // FullCalendar aceita só date
      // normalizar time: garantir segundos
      if (timeStr.length === 5) timeStr = timeStr + ':00';
      return `${dateStr}T${timeStr}`;
    }

    // Função que recebe um objeto do DB (qualquer um dos formatos) e retorna evento compatível com FullCalendar
    function normalizeEvent(row) {
      // Possíveis chaves:
      // formato A: { id, title, start, end, description, location, image }
      // formato B: { id, nome, data_evento, horario_inicio, horario_fim, descricao, local, capa_url }
      const id = row.id ?? row.ID ?? null;

      const title = row.title ?? row.nome ?? row.nome_evento ?? row.titulo ?? 'Sem título';

      // start / end: preferem start/end se fornecidos
      let start = row.start ?? row.data_evento ?? null;
      let end = row.end ?? null;

      // se start foi só data e há horario_inicio, combine
      if ((start && !start.includes('T')) && (row.horario_inicio || row.horario_inicio === '')) {
        const s = makeIsoDatetime(row.data_evento ?? start, row.horario_inicio);
        start = s;
      } else if (row.data_evento && row.horario_inicio && !row.start) {
        start = makeIsoDatetime(row.data_evento, row.horario_inicio);
      }

      // end similar: prefer end field, senão data+horario_fim
      if (!end && row.data_evento && row.horario_fim) {
        end = makeIsoDatetime(row.data_evento, row.horario_fim);
      } else if (end && !end.includes('T') && row.horario_fim) {
        end = makeIsoDatetime(row.data_evento ?? end, row.horario_fim);
      }

      // Description / location / image
      const description = row.description ?? row.descricao ?? row.detail ?? '';
      const location = row.location ?? row.local ?? '';
      const image = row.image ?? row.capa_url ?? row.capa ?? row.capaUrl ?? null;

      // FullCalendar expects at least start OR end; if none, ignore event (handled by caller)
      return {
        id: id,
        title: title,
        start: start,
        end: end,
        extendedProps: {
          description: description,
          location: location,
          image: image
        }
      };
    }

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const overlay = document.getElementById('overlay');
      const modalClose = document.getElementById('modalClose');
      const btnClose = document.getElementById('btnClose');
      const btnDelete = document.getElementById('btnDelete');
      const modalTitle = document.getElementById('modalTitle');
      const modalDescription = document.getElementById('modalDescription');
      const modalLocation = document.getElementById('modalLocation');
      const modalImage = document.getElementById('modalImage');

      function openModal() { overlay.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
      function closeModal() { overlay.style.display = 'none'; document.body.style.overflow = ''; selectedEventId = null; }

      modalClose.addEventListener('click', closeModal);
      btnClose.addEventListener('click', closeModal);
      overlay.addEventListener('click', function (e) { if (e.target === overlay) closeModal(); });

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        eventClick: function(info) {
          const ev = info.event;
          const props = ev.extendedProps || {};

          // salvar id (FullCalendar usa string ids, convertendo para string garante consistência)
          selectedEventId = ev.id !== undefined && ev.id !== null ? String(ev.id) : null;

          modalTitle.textContent = ev.title || 'Sem título';
          modalDescription.textContent = props.description || props.descricao || 'Sem descrição.';
          modalLocation.textContent = props.location || 'Não informado';

          if (props.image) {
            modalImage.src = props.image;
            modalImage.style.display = 'block';
          } else {
            modalImage.style.display = 'none';
          }

          openModal();
        }
      });

      calendar.render();

      // Carregar eventos do servidor (list_events.php)
      (async function loadEvents() {
        try {
          const resp = await fetch('list_events.php', { cache: 'no-store' });
          if (!resp.ok) {
            console.error('Erro ao buscar eventos: status', resp.status);
            return;
          }
          // ler texto e tentar parse JSON com tratamento
          const text = await resp.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (err) {
            console.error('Resposta inválida de list_events.php (não JSON):', text);
            return;
          }

          if (!Array.isArray(data)) {
            console.error('list_events.php não retornou um array:', data);
            return;
          }

          // Normalizar e adicionar
          data.forEach(row => {
            const ev = normalizeEvent(row);
            // só adicionar se tiver start ou end (FullCalendar aceita apenas date OR start)
            if (!ev.start && !ev.end) {
              // tentativa: se row.data_evento existe, use somente data como start
              if (row.data_evento) ev.start = row.data_evento;
              else {
                console.warn('Evento ignorado (sem data):', row);
                return;
              }
            }
            // adicionar evento ao calendário
            calendar.addEvent(ev);
          });
        } catch (err) {
          console.error('Erro carregando eventos:', err);
        }
      })();

      // Exclusão: chama delete_event.php (POST JSON {id})
      btnDelete.addEventListener('click', async function () {
        if (!selectedEventId) { alert('ID do evento não encontrado.'); return; }
        if (!confirm('Deseja realmente excluir este evento? Esta ação não pode ser desfeita.')) return;

        try {
          const res = await fetch('delete_event.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: selectedEventId })
          });

          const text = await res.text();
          let json;
          try { json = JSON.parse(text); } catch (e) { console.error('Resposta não-JSON:', text); alert('Resposta inesperada do servidor. Veja console.'); return; }

          if (!res.ok) {
            alert(json.erro || 'Erro ao excluir evento.');
            return;
          }

          // remover visualmente do calendário
          const ev = calendar.getEventById(String(selectedEventId));
          if (ev) ev.remove();

          closeModal();
          alert(json.mensagem || 'Evento excluído com sucesso.');
        } catch (err) {
          console.error('Erro ao excluir evento:', err);
          alert('Falha na comunicação com o servidor.');
        }
      });

    }); // DOMContentLoaded
  </script>
</body>
</html>
