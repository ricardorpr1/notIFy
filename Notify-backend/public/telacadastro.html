<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro - notIFy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .card { background:#fff; padding:28px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); width:360px; }
    h2 { margin:0 0 12px 0; color:#045c3f; text-align:center; }
    label { display:block; margin-top:8px; font-size:14px; color:#444; }
    input, select { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
    button { width:100%; padding:12px; margin-top:14px; border:none; border-radius:8px; background:#045c3f; color:#fff; font-weight:700; cursor:pointer; }
    .msg { display:none; padding:10px; border-radius:6px; margin-top:10px; }
    .msg.success { background:#e6f7ea; color:#0b6b33; border:1px solid #cde9d2; }
    .msg.error { background:#fdecea; color:#a94442; border:1px solid #f3c6c6; }
    .small { font-size:13px; color:#666; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Criar conta — notIFy</h2>

    <form id="formCadastro" novalidate>
      <label for="nome">Nome completo *</label>
      <input id="nome" name="nome" type="text" required>

      <label for="email">E-mail *</label>
      <input id="email" name="email" type="email" required>

      <label for="senha">Senha *</label>
      <input id="senha" name="senha" type="password" required>

      <label for="telefone">Telefone</label>
      <input id="telefone" name="telefone" type="tel">

      <label for="cpf">CPF * (somente números ou formatado)</label>
      <input id="cpf" name="cpf" type="text" placeholder="123.456.789-10" required>

      <label for="nascimento">Data de nascimento *</label>
      <input id="nascimento" name="nascimento" type="date" required>

      <label for="ra">Registro Acadêmico (RA) *</label>
      <input id="ra" name="ra" type="text" required>

      <button type="submit">Cadastrar</button>
    </form>

    <div id="msgSuccess" class="msg success"></div>
    <div id="msgError" class="msg error"></div>

    <p class="small">Já tem conta? <a href="telalogin.html">Entrar</a></p>
  </div>

  <script>
    const form = document.getElementById('formCadastro');
    const msgSuccess = document.getElementById('msgSuccess');
    const msgError = document.getElementById('msgError');

    function showSuccess(text){
      msgError.style.display='none';
      msgSuccess.textContent = text;
      msgSuccess.style.display='block';
    }
    function showError(text){
      msgSuccess.style.display='none';
      msgError.textContent = text;
      msgError.style.display='block';
    }
    function clearMessages(){ msgSuccess.style.display='none'; msgError.style.display='none'; }

    // normalize CPF: keep digits only and format to XXX.XXX.XXX-XX when sending (or keep digits if you prefer)
    function normalizeCPF(raw){
      const digits = String(raw || '').replace(/\D/g,'');
      if (digits.length !== 11) return raw; // keep original, backend will validate
      return digits.slice(0,3)+'.'+digits.slice(3,6)+'.'+digits.slice(6,9)+'-'+digits.slice(9,11);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();

      const data = {
        nome: document.getElementById('nome').value.trim(),
        email: document.getElementById('email').value.trim(),
        senha: document.getElementById('senha').value,
        telefone: document.getElementById('telefone').value.trim(),
        cpf: normalizeCPF(document.getElementById('cpf').value),
        nascimento: document.getElementById('nascimento').value, // YYYY-MM-DD
        ra: document.getElementById('ra').value.trim()
      };

      // client-side required check
      if (!data.nome || !data.email || !data.senha || !data.cpf || !data.nascimento || !data.ra) {
        showError('Preencha todos os campos obrigatórios marcados com *.');
        return;
      }

      try {
        const res = await fetch('register_user.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'same-origin'
        });

        const text = await res.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch (err) { showError('Resposta inválida do servidor.'); console.error(text); return; }

        if (res.ok) {
          showSuccess(json.mensagem || 'Cadastrado com sucesso! Redirecionando...');
          setTimeout(() => window.location.href = 'telalogin.html', 1200);
        } else {
          showError(json.erro || ('Erro: ' + res.status));
        }
      } catch (err) {
        console.error(err);
        showError('Erro de conexão. Tente novamente.');
      }
    });
  </script>
</body>
</html>
